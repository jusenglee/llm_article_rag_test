<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>RAG Query Web</title>
  <style>
    body {
      font-family: 'Segoe UI', Pretendard, sans-serif;
      background: #f6f8fa;
      color: #222;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h2 {
      margin-top: 60px;
      color: #1e88e5;
      font-weight: 700;
    }

    form {
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 700px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    textarea {
      resize: none;
      font-size: 16px;
      line-height: 1.5;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      transition: 0.2s;
    }
    textarea:focus {
      border-color: #1e88e5;
      box-shadow: 0 0 0 3px rgba(30,136,229,0.2);
      outline: none;
    }

    button {
      align-self: flex-end;
      background: #1e88e5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      padding: 10px 20px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #1565c0;
    }

    #result {
      width: 90%;
      max-width: 700px;
      background: #fff;
      margin-top: 25px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      line-height: 1.7;
    }

    #stream-log {
      white-space: pre-line;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 12px;
      margin-top: 15px;
      font-family: monospace;
      font-size: 14px;
      color: #333;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      width: 90%;
      max-width: 700px;
    }

    .loading {
      text-align: center;
      font-size: 18px;
      color: #666;
      animation: blink 1.2s infinite;
    }
    @keyframes blink {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }
  </style>
</head>
<body>

<h2>ğŸ” ì—°êµ¬ ë…¼ë¬¸ ì§ˆì˜ì‘ë‹µ</h2>

<form id="qform">
  <textarea name="question" id="question" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
  <button type="submit">ì§ˆì˜</button>
</form>

<div id="result"></div>

<div id="stream-log"></div>

<script>
  const form = document.getElementById("qform");
  const resultDiv = document.getElementById("result");
  const logBox = document.getElementById("stream-log");

  // ------------------------------
  // HTML ì´ìŠ¤ì¼€ì´í”„
  // ------------------------------
  function escapeHtml(str) {
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
  }

  // ------------------------------
  // ëª¨ë¸ ì‘ë‹µ ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ…
  //  - case A: * ë¡œ ë‚˜ë‰œ bullet ìŠ¤íƒ€ì¼
  //  - case B: "1. ì œëª© ..." ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
  //  + ì°¸ê³ ë¬¸í—Œ ì„¹ì…˜ ë¶„ë¦¬
  // ------------------------------
  function formatAnswer(rawText) {
    if (!rawText || !rawText.trim()) {
      return "<p>(ë¹ˆ ì‘ë‹µ)</p>";
    }

    // 1) "ì°¸ê³ ë¬¸í—Œ" ê¸°ì¤€ìœ¼ë¡œ ë³¸ë¬¸ / ì°¸ê³ ë¬¸í—Œ ë¶„ë¦¬ (":" ìœ ë¬´ ëª¨ë‘ ì²˜ë¦¬)
    let body = rawText;
    let refs = "";

    const refMatch = rawText.match(/([\s\S]*?)(?:ì°¸ê³ ë¬¸í—Œ[:\s]*)([\s\S]*)/);
    if (refMatch) {
      body = refMatch[1].trim();
      refs = refMatch[2].trim();
    } else {
      body = rawText.trim();
    }

    let html = "";

    // -------------------------------------------------
    // 2) case A: '*' ë¡œ êµ¬ë¶„ëœ bullet ìŠ¤íƒ€ì¼
    // -------------------------------------------------
    if (body.includes("*")) {
      const parts = body.split("*");
      const intro = parts[0].trim();
      const bulletCandidates = parts.slice(1);

      if (intro) {
        html += `<p>${escapeHtml(intro)}</p>`;
      }

      const bullets = bulletCandidates
          .map(t => t.trim())
          .filter(t => t.length > 0);

      if (bullets.length > 0) {
        html += "<ul>";
        for (const b of bullets) {
          html += `<li>${escapeHtml(b)}</li>`;
        }
        html += "</ul>";
      }

    } else {
      // -------------------------------------------------
      // 3) case B: "1. ì œëª© ..." ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
      // -------------------------------------------------

      // ìˆ«ì. íŒ¨í„´ ì•ì— ì¤„ë°”ê¿ˆì„ ê°•ì œë¡œ ë„£ì–´ í† ë§‰ìœ¼ë¡œ ë§Œë“¤ê¸° ì‰½ê²Œ
      // ì˜ˆ) "...ìŠµë‹ˆë‹¤.1.\n\në””ì§€í„¸ ì˜ì•½:" â†’ "...ìŠµë‹ˆë‹¤.\n1.\n\në””ì§€í„¸ ì˜ì•½:"
      let normalized = body.replace(/(\d+)\.\s*/g, "\n$1. ");

      const lines = normalized.split(/\n+/);
      const introLines = [];
      const items = [];
      let current = null;

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;

        const m = line.match(/^(\d+)\.\s*(.*)$/);
        if (m) {
          // ìƒˆ ë²ˆí˜¸ í•­ëª© ì‹œì‘
          if (current) items.push(current);

          const num = m[1];
          let title = m[2].trim();

          // "1."ë§Œ ìˆê³  ì œëª©ì´ ì—†ìœ¼ë©´, ë‹¤ìŒ ì¤„ì„ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
          if (!title && i + 1 < lines.length) {
            const next = lines[i + 1].trim();
            if (next) {
              title = next;
              i++; // ì œëª©ìœ¼ë¡œ ì‚¬ìš©í–ˆìœ¼ë‹ˆ í•œ ì¤„ ê±´ë„ˆë›´ë‹¤
            }
          }

          // ì œëª© ëì´ ì½œë¡ ì´ë©´ ì œê±°
          title = title.replace(/:$/, "");

          current = { num, title, body: "" };
        } else {
          // ì¼ë°˜ í…ìŠ¤íŠ¸ ë¼ì¸
          if (!current) {
            // ì•„ì§ ì–´ë–¤ í•­ëª©ë„ ì‹œì‘ ì•ˆ í–ˆìœ¼ë©´ ì¸íŠ¸ë¡œ ë¬¸ì¥ìœ¼ë¡œ ì¶•ì 
            introLines.push(line);
          } else {
            current.body += (current.body ? "\n" : "") + line;
          }
        }
      }
      if (current) items.push(current);

      // ì¸íŠ¸ë¡œ ë¬¸ë‹¨
      if (introLines.length > 0) {
        html += `<p>${escapeHtml(introLines.join(" "))}</p>`;
      }

      // ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
      if (items.length > 0) {
        html += "<ol>";
        for (const it of items) {
          const title = it.title ? `<strong>${escapeHtml(it.title)}</strong>` : "";
          const bodyText = it.body ? escapeHtml(it.body) : "";
          if (title && bodyText) {
            html += `<li>${title}<br>${bodyText}</li>`;
          } else if (title) {
            html += `<li>${title}</li>`;
          } else {
            html += `<li>${bodyText}</li>`;
          }
        }
        html += "</ol>";
      }
    }

    // -------------------------------------------------
    // 4) ì°¸ê³ ë¬¸í—Œ ì„¹ì…˜ (ê³µí†µ)
    // -------------------------------------------------
    if (refs) {
      let refsEscaped = escapeHtml(refs);
      // [1], [2] ê°™ì€ ë²ˆí˜¸ëŠ” êµµê²Œ
      refsEscaped = refsEscaped.replace(/\[(\d+)\]/g, '<strong>[$1]</strong>');
      html += `<h4 style="margin-top:20px;">ì°¸ê³ ë¬¸í—Œ</h4>`;
      html += `<p style="font-size:14px; color:#555; white-space:pre-line;">${refsEscaped}</p>`;
    }

    return html;
  }

  // ------------------------------
  // í¼ ì œì¶œ + SSE ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
  // ------------------------------
  form.onsubmit = async (e) => {
    e.preventDefault();
    const q = document.getElementById("question").value.trim();
    if (!q) return;

    // ì´ˆê¸°í™”
    resultDiv.textContent = "â³ ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    resultDiv.classList.add("loading");
    logBox.textContent = "";

    if (window.eventSource) window.eventSource.close();

    const url = "/query/stream?question=" + encodeURIComponent(q);
    const es = new EventSource(url);
    window.eventSource = es;

    let rawText = "";   // ì „ì²´ ì›ë³¸ í…ìŠ¤íŠ¸ ëˆ„ì 

    es.onmessage = (ev) => {
      const line = ev.data;

      // ì¢…ë£Œ ì²˜ë¦¬
      if (line === "[END]") {
        es.close();
        const html = formatAnswer(rawText);
        resultDiv.classList.remove("loading");
        resultDiv.innerHTML = html;
        return;
      }

      // STEP ë¡œê·¸
      if (line.startsWith("[STEP")) {
        logBox.textContent += "ğŸ”¹ " + line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // ê²½ê³ /ì˜¤ë¥˜
      if (line.startsWith("âš ï¸") || line.startsWith("ERR")) {
        logBox.textContent += "â— " + line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // -------------------------
      // ğŸ¤– LLM í† í° ìŠ¤íŠ¸ë¦¬ë°
      // -------------------------
      rawText += line;   // í›„ì²˜ë¦¬ìš© ì „ì²´ í…ìŠ¤íŠ¸ ëˆ„ì 

      if (resultDiv.textContent.startsWith("â³")) {
        resultDiv.textContent = "";
        resultDiv.classList.remove("loading");
      }

      // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ëŠ” ê·¸ëƒ¥ ìƒí…ìŠ¤íŠ¸ë¡œ ë³´ì—¬ì£¼ê³ ,
      // [END]ì—ì„œ ì˜ˆì˜ê²Œ ê°ˆì•„ë¼ìš°ëŠ” ë°©ì‹
      resultDiv.textContent += line;
      resultDiv.scrollTop = resultDiv.scrollHeight;
    };

    es.onerror = (err) => {
      console.error("SSE error:", err);
      logBox.textContent += "\nâ— SSE ì˜¤ë¥˜ ë°œìƒ\n";
      es.close();
      resultDiv.classList.remove("loading");
    };
  };
</script>

</body>
</html>
