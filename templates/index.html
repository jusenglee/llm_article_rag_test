<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>RAG Dual Stack Query Web</title>
  <style>
    body {
      font-family: 'Segoe UI', Pretendard, sans-serif;
      background: #f6f8fa;
      color: #222;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h2 {
      margin-top: 40px;
      color: #1e88e5;
      font-weight: 700;
    }

    form {
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    textarea {
      resize: none;
      font-size: 16px;
      line-height: 1.5;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      transition: 0.2s;
    }
    textarea:focus {
      border-color: #1e88e5;
      box-shadow: 0 0 0 3px rgba(30,136,229,0.2);
      outline: none;
    }

    button {
      align-self: flex-end;
      background: #1e88e5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      padding: 10px 20px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background: #1565c0; }

    .answers-wrapper {
      width: 90%;
      max-width: 1100px;
      margin-top: 25px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 16px 18px;
      line-height: 1.7;
    }

    .card h3 {
      margin: 0 0 8px 0;
      font-size: 15px;
      color: #555;
      font-weight: 600;
    }

    #answer-main,
    #answer-a,
    #answer-b {
      font-size: 15px;
      white-space: normal;
    }

    .answer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    #stream-log {
      background:#f8f9fa;
      border-radius:10px;
      padding:12px;
      margin-top:5px;
      font-family:monospace;
      font-size:14px;
      color:#333;
      max-height:260px;
      overflow-y:auto;
      border:1px solid #ddd;
      white-space:pre-line;
    }

    .loading {
      text-align: left;
      font-size: 14px;
      color: #666;
    }

    /* ğŸ‘‡ ëª¨ë¸ ì„ íƒ ì˜ì—­ ìŠ¤íƒ€ì¼ (ì‚´ì§ë§Œ) */
    .model-row {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 14px;
    }
    .model-row label {
      font-weight: 600;
      color: #444;
      min-width: 80px;
    }
    .model-row select {
      flex: 1;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h2>ğŸ” ì—°êµ¬ ë…¼ë¬¸ ì§ˆì˜ì‘ë‹µ (ë“€ì–¼ ì„ë² ë”© ë¹„êµ)</h2>

<form id="qform">
  <!-- ğŸ‘‡ ëª¨ë¸ ì„ íƒ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì¶”ê°€ -->
  <div class="model-row">
    <label for="modelSelect">ëª¨ë¸ ì„ íƒ</label>
    <select id="modelSelect" name="model">
      <!-- value ê°’ì€ ì„œë²„ì—ì„œ ì‚¬ìš©í•˜ëŠ” í‚¤(gpt/gemma/exaone)ë¡œ ë§ì¶°ë‘ê³ ,
           FastAPIì—ì„œ MODEL_MAP ìœ¼ë¡œ Triton ëª¨ë¸ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ë©´ ë¨ -->
      <option value="gpt">GPT-OSS (gpt_oss_0)</option>
      <option value="gemma">Gemma vLLM (gemma_vllm_0)</option>
      <!-- EXAONE ë¶™ì´ë©´ ì—¬ê¸° í™œì„±í™”
      <option value="exaone">EXAONE-4.0 32B</option>
      -->
    </select>
  </div>

  <textarea name="question" id="question" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
  <button type="submit">ì§ˆì˜</button>
</form>

<div class="answers-wrapper">

  <!-- â†“â†“â†“ CHAT ëª¨ë“œ ì „ìš© ë©”ì¸ ì‘ë‹µ ì¹´ë“œ â†“â†“â†“ -->
  <div id="answer-main-card" class="card" style="display:none;">
    <h3>ğŸ’¬ Chat ëª¨ë“œ ì‘ë‹µ</h3>
    <div id="answer-main" class="loading">
      RAGê°€ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš° ì¼ë°˜ Chat ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
    </div>
  </div>
  <!-- â†‘â†‘â†‘ CHAT ëª¨ë“œ ì „ìš© ë©”ì¸ ì‘ë‹µ ì¹´ë“œ â†‘â†‘â†‘ -->

  <!-- A / B ë¹„êµ ì˜ì—­ -->
  <div class="answer-grid">
    <div id="answer-a-card" class="card">
      <h3>ğŸ…° RAG-A ì‘ë‹µ (BAAI/bge-m3)</h3>
      <div id="answer-a" class="loading">
        ë“€ì–¼ RAG ëª¨ë“œì—ì„œ A ìŠ¤íƒ ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>
    <div id="answer-b-card" class="card">
      <h3>ğŸ…± RAG-B ì‘ë‹µ (intfloat/multilingual-e5-large ìŠ¤íƒ)</h3>
      <div id="answer-b" class="loading">
        ë“€ì–¼ RAG ëª¨ë“œì—ì„œ B ìŠ¤íƒ ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- ìŠ¤íŠ¸ë¦¼ ë¡œê·¸ -->
  <div class="card">
    <h3>ğŸ“œ ìŠ¤íŠ¸ë¦¬ë° ë¡œê·¸</h3>
    <div id="stream-log"></div>
  </div>
</div>

<script>
  const form = document.getElementById("qform");
  const mainDiv = document.getElementById("answer-main");
  const mainCard = document.getElementById("answer-main-card");
  const aDiv = document.getElementById("answer-a");
  const bDiv = document.getElementById("answer-b");
  const logBox = document.getElementById("stream-log");
  const modelSelect = document.getElementById("modelSelect");

  // ------------------------------
  // HTML ì´ìŠ¤ì¼€ì´í”„
  // ------------------------------
  function escapeHtml(str) {
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
  }

  // ------------------------------
  // ëª¨ë¸ ì‘ë‹µ ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ…
  // ------------------------------
  function formatAnswer(rawText) {
    if (!rawText || !rawText.trim()) {
      return "<p>(ë¹ˆ ì‘ë‹µ)</p>";
    }

    // 0) <ANSWER> ... </ANSWER> ì•ˆìª½ë§Œ ì‚¬ìš©
    const answerMatch = rawText.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/i);
    if (answerMatch) {
      rawText = answerMatch[1].trim();
    }

    // 1) "ì°¸ê³ ë¬¸í—Œ" ê¸°ì¤€ìœ¼ë¡œ ë³¸ë¬¸ / ì°¸ê³ ë¬¸í—Œ ë¶„ë¦¬
    let body = rawText;
    let refs = "";

    const refMatch = rawText.match(/([\s\S]*?)(?:ì°¸ê³ ë¬¸í—Œ[:\s]*)([\s\S]*)/);
    if (refMatch) {
      body = refMatch[1].trim();
      refs = refMatch[2].trim();
    } else {
      body = rawText.trim();
    }

    let html = "";

    // case A: '*' bullet
    if (body.includes("*")) {
      const parts = body.split("*");
      const intro = parts[0].trim();
      const bulletCandidates = parts.slice(1);

      if (intro) {
        html += `<p>${escapeHtml(intro)}</p>`;
      }

      const bullets = bulletCandidates
          .map(t => t.trim())
          .filter(t => t.length > 0);

      if (bullets.length > 0) {
        html += "<ul>";
        for (const b of bullets) {
          html += `<li>${escapeHtml(b)}</li>`;
        }
        html += "</ul>";
      }

    } else {
      // case B: "1. ì œëª© ..." ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
      let normalized = body.replace(/(\d+)\.\s*/g, "\n$1. ");

      const lines = normalized.split(/\n+/);
      const introLines = [];
      const items = [];
      let current = null;

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;

        const m = line.match(/^(\d+)\.\s*(.*)$/);
        if (m) {
          if (current) items.push(current);

          const num = m[1];
          let title = m[2].trim();

          if (!title && i + 1 < lines.length) {
            const next = lines[i + 1].trim();
            if (next) {
              title = next;
              i++;
            }
          }

          title = title.replace(/:$/, "");
          current = { num, title, body: "" };
        } else {
          if (!current) {
            introLines.push(line);
          } else {
            current.body += (current.body ? "\n" : "") + line;
          }
        }
      }
      if (current) items.push(current);

      if (introLines.length > 0) {
        html += `<p>${escapeHtml(introLines.join(" "))}</p>`;
      }

      if (items.length > 0) {
        html += "<ol>";
        for (const it of items) {
          const title = it.title ? `<strong>${escapeHtml(it.title)}</strong>` : "";
          const bodyText = it.body ? escapeHtml(it.body) : "";
          if (title && bodyText) {
            html += `<li>${title}<br>${bodyText}</li>`;
          } else if (title) {
            html += `<li>${title}</li>`;
          } else {
            html += `<li>${bodyText}</li>`;
          }
        }
        html += "</ol>";
      }
    }

    // 4) ì°¸ê³ ë¬¸í—Œ ì„¹ì…˜
    if (refs) {
      let refsEscaped = escapeHtml(refs);
      refsEscaped = refsEscaped.replace(/\[(\d+)\]/g, '<strong>[$1]</strong>');
      html += `<h4 style="margin-top:20px;">ì°¸ê³ ë¬¸í—Œ</h4>`;
      html += `<p style="font-size:14px; color:#555; white-space:pre-line;">${refsEscaped}</p>`;
    }

    return html;
  }

  // ------------------------------
  // í¼ ì œì¶œ + SSE ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
  // ------------------------------
  form.onsubmit = async (e) => {
    e.preventDefault();
    const q = document.getElementById("question").value.trim();
    if (!q) return;

    const modelKey = modelSelect.value; // "gpt" / "gemma" / "exaone" ...

    // ì´ˆê¸°í™”
    if (mainDiv) {
      mainDiv.textContent = "â³ ì¼ë°˜ Chat ì‘ë‹µ ëŒ€ê¸° ì¤‘...";
      mainDiv.classList.add("loading");
      mainDiv.innerHTML = mainDiv.textContent;
    }
    if (mainCard) {
      mainCard.style.display = "none";
    }

    aDiv.textContent = "â³ RAG-A ì‘ë‹µ ëŒ€ê¸° ì¤‘...";
    bDiv.textContent = "â³ RAG-B ì‘ë‹µ ëŒ€ê¸° ì¤‘...";
    aDiv.classList.add("loading");
    bDiv.classList.add("loading");
    logBox.textContent = "";

    let rawMain = "";
    let rawA = "";
    let rawB = "";

    let seenA = false;
    let seenB = false;

    if (window.eventSource) window.eventSource.close();

    const url = "/query/stream"
        + "?model=" + encodeURIComponent(modelKey)
        + "&question=" + encodeURIComponent(q);

    const es = new EventSource(url);
    window.eventSource = es;

    es.onmessage = (ev) => {
      const line = ev.data;

      // ì¢…ë£Œ ì‹ í˜¸
      if (line === "[END]") {
        es.close();

        if (seenA) {
          aDiv.classList.remove("loading");
          aDiv.innerHTML = rawA ? formatAnswer(rawA) : "(A ìŠ¤íƒì—ì„œ ìœ íš¨í•œ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤)";
        }
        if (seenB) {
          bDiv.classList.remove("loading");
          bDiv.innerHTML = rawB ? formatAnswer(rawB) : "(B ìŠ¤íƒì—ì„œ ìœ íš¨í•œ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤)";
        }

        if (!seenA && !seenB && mainDiv) {
          mainDiv.classList.remove("loading");
          mainDiv.innerHTML = formatAnswer(rawMain || "(ë¹ˆ ì‘ë‹µ)");
          mainCard.style.display = "block";

          aDiv.classList.remove("loading");
          bDiv.classList.remove("loading");
          aDiv.textContent = "ì´ë²ˆ ì§ˆë¬¸ì€ RAGê°€ í•„ìš”í•˜ì§€ ì•Šë‹¤ê³  íŒë‹¨ë˜ì–´ ì¼ë°˜ Chatìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.";
          bDiv.textContent = "ì´ë²ˆ ì§ˆë¬¸ì€ RAGê°€ í•„ìš”í•˜ì§€ ì•Šë‹¤ê³  íŒë‹¨ë˜ì–´ ì¼ë°˜ Chatìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.";
        }
        logBox.textContent += "[END]\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // ëª¨ë¸ ë¡œë“œ/ìƒíƒœ
      if (line.startsWith("[MODEL]")) {
        logBox.textContent += line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      if (line.startsWith("[EXPAND]")) {
        logBox.textContent += line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // ë‹¨ê³„ ë¡œê·¸
      if (line.startsWith("[STEP")) {
        logBox.textContent += "ğŸ”¹ " + line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }


      // RAG êµ¬ê°„ í—¤ë”/êµ¬ë¶„ì„ 
      if (line.includes("[RAG-A]") || line.includes("[RAG-B]") || line.startsWith("===")) {
        logBox.textContent += line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // A/B ìŠ¤íƒ ì„ë² ë”© ê²°ê³¼(ë¬¸ì„œ ëª©ë¡) ë¡œê·¸
      if (line.startsWith("[HITS-A")) {
        const text = line.replace(/^\[HITS-A\]\s?/, "");
        logBox.textContent += "[HITS-A] " + text + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }
      if (line.startsWith("[HITS-B")) {
        const text = line.replace(/^\[HITS-B\]\s?/, "");
        logBox.textContent += "[HITS-B]" + text + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // ì—ëŸ¬
      if (line.startsWith("âš ï¸") || line.startsWith("ERR")) {
        logBox.textContent += "â— " + line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      if (!line.trim()) return;

      // A ìŠ¤íƒ ìŠ¤íŠ¸ë¦¼
      if (line.startsWith("[A]")) {
        seenA = true;
        const text = line.replace(/^\[A\]\s?/, "");
        rawA += text;

        if (aDiv.textContent.startsWith("â³")) {
          aDiv.textContent = "";
          aDiv.classList.remove("loading");
        }
        aDiv.textContent += text;
        aDiv.scrollTop = aDiv.scrollHeight;

        // ğŸ‘‡ ë¡œê·¸ì—ë„ ê°™ì´ ë‚¨ê¸°ê¸°

        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // B ìŠ¤íƒ ìŠ¤íŠ¸ë¦¼
      if (line.startsWith("[B]")) {
        seenB = true;
        const text = line.replace(/^\[B\]\s?/, "");
        rawB += text;

        if (bDiv.textContent.startsWith("â³")) {
          bDiv.textContent = "";
          bDiv.classList.remove("loading");
        }
        bDiv.textContent += text;
        bDiv.scrollTop = bDiv.scrollHeight;

        // ğŸ‘‡ ë¡œê·¸ì—ë„ ê°™ì´ ë‚¨ê¸°ê¸°
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // ì„±ëŠ¥ ë¡œê·¸
      if (line.startsWith("[PERF-")) {
        logBox.textContent += line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // ì¼ë°˜ CHAT ëª¨ë“œ ìŠ¤íŠ¸ë¦¼ (RAG ì‚¬ìš© X)
      if (!seenA && !seenB && mainDiv) {
        console.log(seenA)
        console.log(seenB)
        console.log(mainDiv)
        rawMain += line;

        if (mainDiv.textContent.startsWith("â³") || mainDiv.classList.contains("loading")) {
          mainDiv.textContent = "";
          mainDiv.classList.remove("loading");
          mainCard.style.display = "block";
        }
        mainDiv.textContent += line;
        mainDiv.scrollTop = mainDiv.scrollHeight;

        // ğŸ‘‡ Chat ëª¨ë“œì—ì„œë„ ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ ë¡œê·¸ì— ê°™ì´ ì¶œë ¥
        logBox.textContent += line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // í˜¹ì‹œ ìœ„ ì¡°ê±´ì— ì•ˆ ê±¸ë¦¬ëŠ” ë¼ì¸ë“¤ì€ ì•ˆì „í•˜ê²Œ ë¡œê·¸ë¡œë§Œ ë‚¨ê¹€
      logBox.textContent += line + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    };

    es.onerror = (err) => {
      console.error("SSE error:", err);
      logBox.textContent += "\nâ— SSE ì˜¤ë¥˜ ë°œìƒ\n";
      es.close();
      if (mainDiv) mainDiv.classList.remove("loading");
      aDiv.classList.remove("loading");
      bDiv.classList.remove("loading");
    };
  };
</script>


</body>
</html>
