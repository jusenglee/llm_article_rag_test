<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>RAG Query Web</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Pretendard, sans-serif; background: #f6f8fa; color: #222; margin: 0;
      display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    h2 { margin-top: 60px; color: #1e88e5; font-weight: 700; }

    form {
      background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-radius: 12px; padding: 20px;
      width: 90%; max-width: 700px;
      display: flex; flex-direction: column; gap: 12px;
      margin-top: 20px;
    }

    textarea {
      resize: none; font-size: 16px; line-height: 1.5; padding: 12px;
      border-radius: 8px; border: 1px solid #ccc; transition: 0.2s;
    }
    textarea:focus { border-color: #1e88e5; box-shadow: 0 0 0 3px rgba(30,136,229,0.2); }

    button {
      align-self: flex-end; background: #1e88e5; color: #fff;
      border: none; border-radius: 8px;
      font-size: 16px; padding: 10px 20px; cursor: pointer; transition: 0.2s;
    }
    button:hover { background: #1565c0; }

    #result {
      width: 90%; max-width: 700px; background: #fff;
      margin-top: 25px; padding: 20px;
      border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      line-height: 1.7;
      white-space: pre-wrap;
    }

    #logs {
      background: #f1f1f1; border-radius: 8px; padding: 12px;
      font-family: monospace; font-size: 14px;
      margin-top: 16px; white-space: pre-wrap; color: #333;
    }

    .loading { text-align: center; font-size: 18px; color: #666; animation: blink 1.2s infinite; }
    @keyframes blink { 0%{opacity:0.3;} 50%{opacity:1;} 100%{opacity:0.3;} }
  </style>
</head>
<body>

<h2>üîç Ïó∞Íµ¨ ÎÖºÎ¨∏ ÏßàÏùòÏùëÎãµ</h2>

<form id="qform">
  <textarea name="question" id="question" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." rows="3"></textarea>
  <button type="submit">ÏßàÏùò</button>
</form>

<div id="result"></div>
<div id="stream-log"
     style="white-space:pre-line;
            background:#f8f9fa;
            border-radius:10px;
            padding:12px;
            margin-top:15px;
            font-family:monospace;
            font-size:14px;
            color:#333;
            max-height:300px;
            overflow-y:auto;
            border:1px solid #ddd;">
</div>
<script>
  const form = document.getElementById("qform");
  const resultDiv = document.getElementById("result");
  const logBox = document.getElementById("stream-log");

  form.onsubmit = async (e) => {
    e.preventDefault();
    const q = document.getElementById("question").value.trim();
    if (!q) return;

    // Ï¥àÍ∏∞Ìôî
    resultDiv.textContent = "‚è≥ ÏùëÎãµÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...";
    logBox.textContent = "";

    if (window.eventSource) window.eventSource.close();

    const url = "/query/stream?question=" + encodeURIComponent(q);
    const es = new EventSource(url);
    window.eventSource = es;

    let rawText = "";   // Ï†ÑÏ≤¥ ÏõêÎ≥∏ ÌÖçÏä§Ìä∏(ÎßàÌÅ¨Îã§Ïö¥ Í∑∏ÎåÄÎ°ú)

    es.onmessage = (ev) => {
      const line = ev.data;

      // Ï¢ÖÎ£å Ï≤òÎ¶¨
      if (line === "[END]") {
        es.close();
        resultDiv.innerHTML = marked.parse(rawText || "(Îπà ÏùëÎãµ)");
        return;
      }

      // STEP Î°úÍ∑∏
      if (line.startsWith("[STEP")) {
        logBox.textContent += "üîπ " + line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // Í≤ΩÍ≥†/Ïò§Î•ò
      if (line.startsWith("‚ö†Ô∏è") || line.startsWith("ERR")) {
        logBox.textContent += "‚ùó " + line + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        return;
      }

      // -------------------------
      // ü§ñ LLM ÌÜ†ÌÅ∞ Ïä§Ìä∏Î¶¨Î∞ç
      // -------------------------
      rawText += line;                 // ‚Üê Í≥µÎ∞± Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå

      if (resultDiv.textContent.startsWith("‚è≥")) {
        resultDiv.textContent = "";
      }

      resultDiv.textContent += line;  // ‚Üê Í≥µÎ∞± Ï∂îÍ∞ÄÌïòÎ©¥ Ïïà Îê®
      resultDiv.scrollTop = resultDiv.scrollHeight;
    };

    es.onerror = (err) => {
      console.error("SSE error:", err);
      logBox.textContent += "\n‚ùó SSE Ïò§Î•ò Î∞úÏÉù\n";
      es.close();
    };
  };
</script>

</body>
</html>
